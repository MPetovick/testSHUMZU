<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeMesh - Seguridad Comunitaria</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: var(--dark);
        }
        
        header {
            background-color: var(--primary);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        #map {
            flex: 1;
            min-height: 400px;
            z-index: 1;
        }
        
        .controls {
            padding: 1rem;
            background: white;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }
        
        button {
            padding: 0.7rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-emergency {
            background-color: var(--accent);
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        .status {
            display: flex;
            align-items: center;
            margin-left: auto;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .connected {
            background-color: #2ecc71;
        }
        
        .disconnected {
            background-color: #e74c3c;
        }
        
        .user-list {
            position: absolute;
            top: 70px;
            right: 10px;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 250px;
            display: none;
        }
        
        .user-list h3 {
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .user-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .status {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SafeMesh</h1>
            <p>Seguridad comunitaria mediante red mesh</p>
        </header>
        
        <div id="map"></div>
        
        <div class="controls">
            <button id="toggleMesh" class="btn-primary">Activar Red Mesh</button>
            <button id="emergencyBtn" class="btn-emergency">Alerta de Emergencia</button>
            <div class="status">
                <div id="statusIndicator" class="status-indicator disconnected"></div>
                <span id="statusText">Desconectado</span>
            </div>
            <button id="showUsers">Ver Usuarios</button>
        </div>
        
        <div id="userList" class="user-list">
            <h3>Usuarios Conectados</h3>
            <div id="usersContainer"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Simulación de funcionalidad de red mesh y geolocalización
        // En una implementación real, se usarían APIs como WebRTC para peer-to-peer
        // y la API de Geolocalización del navegador
        
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos de la UI
            const toggleMeshBtn = document.getElementById('toggleMesh');
            const emergencyBtn = document.getElementById('emergencyBtn');
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const showUsersBtn = document.getElementById('showUsers');
            const userList = document.getElementById('userList');
            const usersContainer = document.getElementById('usersContainer');
            
            // Estado de la aplicación
            let meshActive = false;
            let map, userMarker, watchId;
            let users = new Map(); // Almacena usuarios conectados
            
            // Colores para usuarios
            const userColors = [
                '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', 
                '#1abc9c', '#d35400', '#c0392b', '#16a085', '#8e44ad'
            ];
            
            // Inicializar mapa
            function initMap() {
                map = L.map('map').setView([40.4168, -3.7038], 13); // Madrid por defecto
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);
                
                // Solicitar geolocalización
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            const { latitude, longitude } = position.coords;
                            map.setView([latitude, longitude], 15);
                            
                            // Marcador del usuario actual
                            userMarker = L.marker([latitude, longitude])
                                .addTo(map)
                                .bindPopup('Tu ubicación')
                                .openPopup();
                        },
                        error => {
                            console.error('Error obteniendo ubicación:', error);
                            alert('No se pudo obtener tu ubicación. Asegúrate de tener activado el GPS.');
                        }
                    );
                } else {
                    alert('Tu navegador no soporta geolocalización.');
                }
            }
            
            // Iniciar seguimiento de ubicación
            function startTracking() {
                if (navigator.geolocation) {
                    watchId = navigator.geolocation.watchPosition(
                        position => {
                            const { latitude, longitude } = position.coords;
                            if (userMarker) {
                                userMarker.setLatLng([latitude, longitude]);
                                map.panTo([latitude, longitude]);
                                
                                // En una app real, enviaríamos esta ubicación a través de la red mesh
                                if (meshActive) {
                                    broadcastLocation(latitude, longitude);
                                }
                            }
                        },
                        error => {
                            console.error('Error en seguimiento de ubicación:', error);
                        },
                        { 
                            enableHighAccuracy: true, 
                            timeout: 10000, 
                            maximumAge: 30000 
                        }
                    );
                }
            }
            
            // Detener seguimiento de ubicación
            function stopTracking() {
                if (watchId && navigator.geolocation) {
                    navigator.geolocation.clearWatch(watchId);
                }
            }
            
            // Simular transmisión de ubicación a través de la red mesh
            function broadcastLocation(lat, lng) {
                // En una implementación real, usaríamos WebRTC o similar
                console.log(`Transmitiendo ubicación: ${lat}, ${lng}`);
                
                // Simular recepción de ubicaciones de otros usuarios
                simulateOtherUsers();
            }
            
            // Simular otros usuarios en la red (en una app real esto sería dinámico)
            function simulateOtherUsers() {
                // Solo simular si estamos conectados
                if (!meshActive) return;
                
                // Generar algunos usuarios aleatorios cerca de la ubicación actual
                const center = userMarker.getLatLng();
                
                // Limpiar usuarios anteriores (excepto el actual)
                users.forEach((user, id) => {
                    if (id !== 'current') {
                        map.removeLayer(user.marker);
                    }
                });
                
                users.clear();
                
                // Añadir usuario actual
                users.set('current', {
                    id: 'current',
                    name: 'Tú',
                    lat: center.lat,
                    lng: center.lng,
                    color: '#3498db',
                    marker: userMarker
                });
                
                // Generar 3-7 usuarios simulados
                const numUsers = Math.floor(Math.random() * 5) + 3;
                for (let i = 0; i < numUsers; i++) {
                    const id = `user-${i}`;
                    const lat = center.lat + (Math.random() * 0.02 - 0.01);
                    const lng = center.lng + (Math.random() * 0.02 - 0.01);
                    const color = userColors[i % userColors.length];
                    
                    // Crear marcador para el usuario simulado
                    const marker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'user-marker',
                            html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 3px ${color}40;"></div>`,
                            iconSize: [12, 12],
                            iconAnchor: [6, 6]
                        })
                    }).addTo(map);
                    
                    // Añadir a la lista de usuarios
                    users.set(id, {
                        id,
                        name: `Usuario ${i+1}`,
                        lat,
                        lng,
                        color,
                        marker
                    });
                }
                
                updateUserList();
            }
            
            // Actualizar lista de usuarios en la UI
            function updateUserList() {
                usersContainer.innerHTML = '';
                
                users.forEach(user => {
                    if (user.id === 'current') return; // No mostrar el usuario actual en la lista
                    
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    userItem.innerHTML = `
                        <div class="user-color" style="background-color: ${user.color}"></div>
                        <div>${user.name}</div>
                    `;
                    
                    usersContainer.appendChild(userItem);
                });
            }
            
            // Alternar estado de la red mesh
            toggleMeshBtn.addEventListener('click', function() {
                meshActive = !meshActive;
                
                if (meshActive) {
                    // Activar red mesh
                    statusIndicator.className = 'status-indicator connected';
                    statusText.textContent = 'Conectado';
                    toggleMeshBtn.textContent = 'Desactivar Red Mesh';
                    startTracking();
                    
                    // Simular conexión con otros usuarios
                    setTimeout(simulateOtherUsers, 1000);
                } else {
                    // Desactivar red mesh
                    statusIndicator.className = 'status-indicator disconnected';
                    statusText.textContent = 'Desconectado';
                    toggleMeshBtn.textContent = 'Activar Red Mesh';
                    stopTracking();
                    
                    // Eliminar todos los usuarios excepto el actual
                    users.forEach((user, id) => {
                        if (id !== 'current') {
                            map.removeLayer(user.marker);
                        }
                    });
                    
                    // Mantener solo el usuario actual
                    const currentUser = users.get('current');
                    users.clear();
                    if (currentUser) {
                        users.set('current', currentUser);
                    }
                    
                    updateUserList();
                }
            });
            
            // Manejar alerta de emergencia
            emergencyBtn.addEventListener('click', function() {
                if (!meshActive) {
                    alert('Por favor, activa la red mesh primero para enviar una alerta.');
                    return;
                }
                
                const confirmation = confirm('¿Estás seguro de que quieres enviar una alerta de emergencia?');
                if (confirmation) {
                    // En una app real, enviaríamos una alerta a través de la red mesh
                    alert('¡Alerta de emergencia enviada a la comunidad!');
                    
                    // Destellar el botón de emergencia
                    let flashCount = 0;
                    const flashInterval = setInterval(() => {
                        emergencyBtn.style.visibility = emergencyBtn.style.visibility === 'hidden' ? 'visible' : 'hidden';
                        flashCount++;
                        
                        if (flashCount > 10) {
                            clearInterval(flashInterval);
                            emergencyBtn.style.visibility = 'visible';
                        }
                    }, 200);
                }
            });
            
            // Mostrar/ocultar lista de usuarios
            showUsersBtn.addEventListener('click', function() {
                if (userList.style.display === 'block') {
                    userList.style.display = 'none';
                } else {
                    userList.style.display = 'block';
                }
            });
            
            // Cerrar lista de usuarios al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!userList.contains(e.target) && e.target !== showUsersBtn) {
                    userList.style.display = 'none';
                }
            });
            
            // Inicializar la aplicación
            initMap();
        });
    </script>
</body>
</html>